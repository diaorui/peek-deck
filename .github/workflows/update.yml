name: Update Widgets

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:  # Allow manual triggers
    inputs:
      clear_cache:
        description: 'Clear all data/cache before running'
        required: false
        type: boolean
        default: false

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 1  # Shallow clone - only need latest code

      - name: Setup git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Restore cache from data branch
        run: |
          # Try to fetch and restore cache from data branch (shallow fetch)
          if git fetch --depth=1 origin data:refs/remotes/origin/data 2>/dev/null && \
             git ls-remote --exit-code --heads origin data >/dev/null 2>&1; then
            echo "ðŸ“¦ Restoring data from data branch..."

            # Check and restore each directory individually
            if git ls-tree -r origin/data --name-only | grep -q "^data/cache/"; then
              git checkout origin/data -- data/cache/
              echo "   - Cache timestamps restored"
            fi

            if git ls-tree -r origin/data --name-only | grep -q "^data/raw/"; then
              git checkout origin/data -- data/raw/
              echo "   - Raw data restored"
            fi

            if git ls-tree -r origin/data --name-only | grep -q "^data/processed/"; then
              git checkout origin/data -- data/processed/
              echo "   - Processed data restored"
            fi

            if [ -d data/cache ] || [ -d data/raw ] || [ -d data/processed ]; then
              echo "âœ… Data restored successfully"
            else
              echo "âš ï¸  No data found on data branch"
            fi
          else
            echo "â„¹ï¸  Data branch doesn't exist yet, starting fresh"
          fi

      - name: Clear data folder (if requested)
        if: ${{ github.event.inputs.clear_cache == 'true' }}
        run: |
          echo "ðŸ—‘ï¸  Clearing data folder for fresh run..."
          rm -rf data

      - name: Stage 1 - Fetch data
        run: |
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}/src"
          python -m peek_deck fetch
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Stage 2 - Process data
        run: |
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}/src"
          python -m peek_deck process

      - name: Stage 3 - Render HTML
        run: |
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}/src"
          python -m peek_deck render

      - name: Upload artifacts for debugging
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: processing-artifacts
          path: |
            data/raw/
            data/processed/
          retention-days: 7

      - name: Commit and push to data branch
        run: |
          # Store generated files temporarily
          mkdir -p /tmp/my-build
          cp -r docs /tmp/my-build/ || true
          cp -r data/cache /tmp/my-build/ || true
          cp -r data/raw /tmp/my-build/ || true
          cp -r data/processed /tmp/my-build/ || true

          # Fetch data branch (or create if doesn't exist) - shallow fetch
          git fetch --depth=1 origin data:refs/remotes/origin/data || true

          # Check if data branch exists on remote
          if git ls-remote --exit-code --heads origin data; then
            git checkout -B data origin/data
            # Keep only docs/ and data/, remove everything else
            git rm -rf . 2>/dev/null || true
          else
            # Create new orphan branch (no history from main)
            git checkout --orphan data
            git rm -rf . 2>/dev/null || true
          fi

          # Copy generated files back
          cp -r /tmp/my-build/docs . || true
          mkdir -p data
          cp -r /tmp/my-build/cache data/ || true
          cp -r /tmp/my-build/raw data/ || true
          cp -r /tmp/my-build/processed data/ || true

          # Add only generated files (no source code)
          # Use -f to force add docs/ and data/ which may be in .gitignore
          git add -f docs/ data/

          # Commit if there are changes
          git diff --quiet && git diff --staged --quiet || \
            (git commit -m "Update widgets - $(date -u +'%Y-%m-%d %H:%M:%S UTC')" && \
             git push origin data)

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          keep_files: true  # Preserve CNAME and other files not in ./docs
